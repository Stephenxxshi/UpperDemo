# MES 接口调试工具使用说明

## 概述

MES 接口调试工具是一个完整的 WPF 调试界面，用于测试 `IMesService`（锐派接口）和 `IMesWebApi`（工单推送接口）。

## ?? 快速开始

### 1. 启动应用

运行 `Plant01.Upper.Wpf` 项目，在导航菜单中点击 **"MES调试"** 进入调试界面。

### 2. 界面布局

调试界面分为三个主要区域：

1. **锐派接口测试区域** - 测试 `IMesService` 的两个接口
2. **工单接口测试区域** - 测试 `IMesWebApi` 的工单推送接口  
3. **调试日志区域** - 实时显示调试日志和接口响应

## ?? 功能说明

### 一、锐派接口测试 (IMesService)

#### 1.1 认证密钥生成

**新功能**: 生成锐派认证密钥

**测试步骤**:
1. 填写认证参数：
   - CorpNo: 客户序号（如：020）
   - CorpId: 客户密钥（如：IezQB0Esc1mN4Tf7Xw83U3tv7eEy33PJ）

2. 点击 **"生成密钥"** 按钮

3. 生成的认证密钥将显示在认证密钥字段（只读）

**密钥生成规则**:
- 格式: `CorpNo&auth_sys_time&auth_sign_code`
- `auth_sys_time`: 当前时间戳（10位数字，精确到秒）
- `auth_sign_code`: MD5("auth_sys_time&CorpId")
- **重要**: 密钥有效期为2分钟

**日志输出示例**:
```
[14:30:10.123] ========== 生成锐派密钥 ==========
[14:30:10.124] CorpNo: 020
[14:30:10.125] CorpId: IezQB0Esc1mN4Tf7Xw83U3tv7eEy33PJ
[14:30:10.126] 时间戳: 1704096610
[14:30:10.127] 签名字符串: 1704096610&IezQB0Esc1mN4Tf7Xw83U3tv7eEy33PJ
[14:30:10.128] MD5 签名: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
[14:30:10.129] ? 生成的密钥: 020&1704096610&a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
[14:30:10.130] ? 密钥有效期: 2分钟
[14:30:10.131] =====================================
```

#### 1.2 测试码垛完成接口

**接口**: `FinishPalletizingAsync`

**测试步骤**:
1. 先生成认证密钥（见1.1）

2. 填写公共参数：
   - AGV设备编号（如：AGV001）
   - 托盘ID（如：P00001）
   - 设备编号（如：Palletizing）
   - 任务ID（如：10000）

3. 填写打包明细：
   - 包号1、数量1
   - 包号2、数量2

4. 点击 **"测试码垛完成"** 按钮

**日志输出示例**:
```
[14:30:15.123] ========== 锐派码垛完成 ==========
[14:30:15.124] 认证密钥: 020&1704096610&a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
[14:30:15.125] AGV设备: AGV001
[14:30:15.126] 托盘ID: P00001
[14:30:15.127] 设备编号: Palletizing
[14:30:15.128] 任务ID: 10000
[14:30:15.129] 打包明细: [A001:20, A002:30]
[14:30:15.250] ? 成功：
[14:30:15.251] =====================================
```

#### 1.3 测试托盘缺少接口

**接口**: `ReportLackPalletAsync`

**测试步骤**:
1. 先生成认证密钥（见1.1）

2. 填写AGV设备编号
3. 选择托盘类型：
   - 1 = 母托盘
   - 2 = 子托盘

4. 点击 **"测试托盘缺少"** 按钮

**日志输出示例**:
```
[14:32:20.456] ========== 锐派托盘缺少 ==========
[14:32:20.457] 认证密钥: 020&1704096610&a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
[14:32:20.458] AGV设备: AGV001
[14:32:20.459] 托盘类型: 1 (母托盘)
[14:32:20.550] ? 成功：
[14:32:20.551] =====================================
```

### 二、工单接口测试 (IMesWebApi)

#### 2.1 设置 Basic 认证

**接口**: `SetBasicAuth`

**测试步骤**:
1. 填写用户名（默认：admin）
2. 填写密码（默认：123456）
3. 点击 **"设置认证"** 按钮

**说明**: 必须先设置认证才能调用工单推送接口。

**日志输出示例**:
```
[14:35:10.789] ========== 设置 Basic 认证 ==========
[14:35:10.790] 用户名: admin
[14:35:10.791] 密码: ******
[14:35:10.792] ? Basic 认证已设置
[14:35:10.793] =====================================
```

#### 2.2 工单推送接口

**接口**: `CreateWorkOrderAsync`

**测试步骤**:
1. 先设置 Basic 认证（见上）
2. 填写工单参数：
   - 工单号（如：WO20240101001）
   - 工单日期
   - 产线编号（如：LINE001）
   - 产品编号（如：P001）
   - 产品名称（如：产品A）
   - 规格型号
   - 计划数量、单位
   - 批号、标签模板编号
   - 状态（1=开工，99=完工）

3. 点击 **"测试工单推送"** 按钮

**日志输出示例**:
```
[14:40:30.123] ========== MES 工单推送 ==========
[14:40:30.124] 工单号: WO20240101001
[14:40:30.125] 工单日期: 2024-01-01
[14:40:30.126] 产线编号: LINE001
[14:40:30.127] 产品: P001 - 产品A
[14:40:30.128] 规格: 规格型号A
[14:40:30.129] 数量: 1000 kg
[14:40:30.130] 批号: BATCH001
[14:40:30.131] 状态: 1 (开工)
[14:40:30.350] ? 成功：
[14:40:30.351] =====================================
```

### 三、日志查看

#### 3.1 日志内容

日志区域实时显示：
- 接口调用参数
- 接口响应结果
- 成功/失败状态
- 错误信息（如果有）
- 时间戳（精确到毫秒）

#### 3.2 日志格式

```
[HH:mm:ss.fff] 日志内容
```

- ? 表示成功
- ? 表示失败或异常

#### 3.3 清空日志

点击 **"清空日志"** 按钮可清空日志区域。

### 四、状态栏

界面底部的状态栏显示当前操作状态：
- `就绪` - 等待操作
- `正在调用xxx接口...` - 接口调用中
- `? xxx接口调用成功` - 成功
- `? xxx接口调用失败: xxx` - 失败

## ?? 配置说明

### appsettings.json 配置

```json
{
  "MesApi": {
    "BaseUrl": "http://WebAPIServer",
    "CorpNo": "020",
    "CorpId": "IezQB0Esc1mN4Tf7Xw83U3tv7eEy33PJ"
  },
  "MesWorkOrder": {
    "BaseUrl": "http://localhost:5000",
    "Username": "admin",
    "Password": "123456"
  },
  "Serilog": {
    "MinimumLevel": "Debug"
  }
}
```

**配置项说明**:

#### MesApi (锐派接口配置)
- `BaseUrl`: 锐派接口服务器地址
- `CorpNo`: 客户序号（如：020）
- `CorpId`: 客户密钥

#### MesWorkOrder (工单接口配置)
- `BaseUrl`: 工单接口服务器地址
- `Username`: Basic 认证用户名
- `Password`: Basic 认证密码

#### 日志配置
- `MinimumLevel`: 建议设置为 `Debug` 以查看详细日志

## ?? 调试技巧

### 1. 查看详细日志

在调试界面的日志区域可以看到：
- 请求参数
- 响应结果
- 错误信息

同时，日志也会输出到：
- 控制台（Console）
- 日志文件（`logs/serilog-*.txt`）

### 2. 查看 ILogger 输出

打开 Visual Studio 的 **输出窗口**（Output Window），可以看到更详细的日志：

```
info: Plant01.Infrastructure.Shared.Services.HttpService[0]
      发送 POST JSON 请求: http://WebAPIServer/api/cmsDeviceData/REVOPACFinishPalletizing
      
info: Plant01.Upper.Application.Services.MesService[0]
      锐派码垛完成接口调用成功，任务ID: 10000
```

### 3. 查看 HTTP 请求详情

在 `HttpService` 中有 Debug 级别的日志：

```csharp
_logger.LogDebug("生成认证密钥，时间戳: {AuthSysTime}, 签名: {AuthSignCode}", authSysTime, authSignCode);
```

确保 `appsettings.json` 中 Serilog 的 `MinimumLevel` 设置为 `Debug`。

### 4. 测试不同场景

#### 场景1: 测试认证失败
修改 `CorpNo` 或 `CorpId` 为错误值，观察错误日志。

#### 场景2: 测试超时
将 `BaseUrl` 改为一个不存在的地址，观察超时处理。

#### 场景3: 测试网络错误
关闭 MES 服务器，观察错误处理。

## ?? 常见问题

### Q1: 按钮点击没有反应

**可能原因**:
1. 接口正在执行中（按钮会被禁用）
2. 查看日志区域是否有错误信息

**解决方案**:
- 等待当前请求完成
- 检查状态栏提示
- 查看日志输出

### Q2: 接口调用失败

**可能原因**:
1. 服务器地址配置错误
2. 认证信息错误（工单接口）
3. 参数验证失败
4. 网络连接问题
5. MES 服务器未启动

**解决方案**:
1. 检查 `appsettings.json` 配置
2. 确认 Basic 认证已设置（工单接口）
3. 检查必填参数是否填写
4. 测试网络连通性
5. 查看日志中的错误信息

### Q3: 日志中显示异常

**查看异常详情**:
1. 查看日志区域的 `? 异常：xxx` 信息
2. 打开 Visual Studio 输出窗口查看完整堆栈
3. 查看日志文件 `logs/serilog-*.txt`

**常见异常**:
- `HttpRequestException`: 网络连接错误
- `TaskCanceledException`: 请求超时
- `JsonException`: JSON 序列化/反序列化错误

## ?? 日志级别说明

调试工具使用不同级别的日志：

| 级别 | 用途 | 示例 |
|------|------|------|
| **Debug** | 详细调试信息 | "生成认证密钥，时间戳: ..." |
| **Information** | 关键操作信息 | "开始调用锐派码垛完成接口" |
| **Warning** | 业务错误 | "锐派码垛完成接口调用失败" |
| **Error** | 异常错误 | "锐派码垛完成接口调用异常" |

## ?? 最佳实践

### 1. 测试流程

建议按以下顺序测试：

1. **先测试锐派接口**（不需要认证）
   - 测试托盘缺少接口（参数较少）
   - 测试码垛完成接口（参数较多）

2. **再测试工单接口**（需要认证）
   - 先设置 Basic 认证
   - 再测试工单推送

### 2. 日志管理

- 定期清空日志，保持界面清爽
- 测试前清空日志，方便查看当前测试结果
- 保存重要的日志到文件（复制日志区域内容）

### 3. 配置管理

- 开发环境和生产环境使用不同的配置
- 不要将真实的密码提交到版本控制
- 使用配置文件管理不同环境的配置

## ?? 扩展开发

如需添加新的接口测试：

1. 在 `IMesService` 或 `IMesWebApi` 中添加新接口
2. 在对应的服务类中实现接口
3. 在 `MesDebugViewModel` 中添加：
   - 参数属性
   - 命令定义
   - 命令实现方法
4. 在 `MesDebugView.xaml` 中添加 UI 控件

## ?? 相关文档

- **MES 服务详细指南**: `docs/MesService-Revopac-Guide.md`
- **HttpService 使用指南**: `docs/HttpService-Usage.md`
- **MES 快速开始**: `docs/MesService-QuickStart.md`

---

**提示**: 调试工具仅用于开发和测试环境，不要在生产环境中使用！
